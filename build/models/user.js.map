{"version":3,"sources":["../../src/models/user.js"],"names":["Joi","objectId","userSchema","mongoose","Schema","email","type","String","required","minlength","maxlength","unique","lowercase","trim","password","websites","Types","ObjectId","ref","currentWebsite","currentAction","Number","methods","generateAuthToken","token","jwt","sign","_id","isAdmin","config","get","createWebsite","website","Website","title","createPage","save","deleteWebsite","res","findById","status","send","Promise","all","pagesStructure","map","item","Page","findByIdAndRemove","id","index","indexOf","splice","length","User","model","validateUser","user","schema","string","min","max","minDomainAtoms","validate"],"mappings":"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","sourcesContent":["import config from 'config'\nimport jwt from 'jsonwebtoken'\nimport Joi from 'joi'\nimport mongoose from 'mongoose'\nimport { Website } from './website'\nimport { Page } from './page'\nimport JoiObjectId from 'joi-objectid'\nJoi.objectId = JoiObjectId(Joi)\n\nconst userSchema = new mongoose.Schema({\n    email: {\n        type: String,\n        required: true,\n        minlength: 5,\n        maxlength: 255,\n        unique: true,\n        lowercase: true,\n        trim: true,\n    },\n    password: {\n        type: String,\n        required: true,\n        minlength: 5,\n        maxlength: 1024,\n    },\n    websites: [\n        {\n            type: mongoose.Schema.Types.ObjectId,\n            ref: 'Website',\n        },\n    ],\n    currentWebsite: {\n        type: mongoose.Schema.Types.ObjectId,\n        ref: 'Websites',\n    },\n    currentAction: {\n        type: Number,\n        required: true,\n    },\n})\n\nuserSchema.methods.generateAuthToken = function() {\n    const token = jwt.sign(\n        { _id: this._id, isAdmin: this.isAdmin },\n        config.get('jwtPrivateKey')\n    )\n    return token\n}\n\nuserSchema.methods.createWebsite = async function() {\n    let website = new Website({\n        title: 'New website',\n    })\n    await website.createPage(website)\n    website = await website.save()\n    this.currentWebsite = website\n    await this.save()\n    return website\n}\n\nuserSchema.methods.deleteWebsite = async function(_id, res) {\n    const website = await Website.findById(_id)\n    if (!website)\n        return res\n            .status(404)\n            .send('The website with the given ID was not found.')\n\n    await Promise.all(\n        website.pagesStructure.map(async item => {\n            await Page.findByIdAndRemove(item.id)\n        })\n    )\n    await Website.findByIdAndRemove(_id)\n    const index = this.websites.indexOf(_id)\n    this.websites.splice(index, 1)\n    if (this.websites.length > 0) {\n        this.currentWebsite = this.websites[0]\n    } else {\n        this.currentWebsite = null\n    }\n}\n\nexport const User = mongoose.model('User', userSchema)\n\nexport const validateUser = (user: {}) => {\n    const schema = {\n        email: Joi.string()\n            .min(5)\n            .max(255)\n            .required()\n            .email({ minDomainAtoms: 2 }),\n        password: Joi.string()\n            .min(5)\n            .max(255)\n            .required(),\n    }\n\n    return Joi.validate(user, schema)\n}\n"],"file":"user.js"}